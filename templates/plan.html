{% extends "base.html" %}

{%load static%}

{% block title %}Plan{% endblock %}
{% block main %}

    <div id="map-canvas"></div>

{% endblock %}

{% block sidebar %}

    <!-- search option -->
    <div>
        <p>
            {% if errors %}
                {{ errors }}
            {% endif %}
        </p>
        <form method="post" id="myform">
            {% csrf_token %}
            <select multiple="multiple" id ="places" name="places">

            </select>
            <input type="submit" value="Submit now" />

        </form>
    </div> <!-- /.share-widget -->
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCvQW0hONU01G0pfrJZ1nZRZuulSY4rG2I&libraries=places"></script>
    <script>
        var directionsService = new google.maps.DirectionsService();
        var map;
        var waypoints = 0;
        var directionsRenderer = new google.maps.DirectionsRenderer();
        var infowindow;
        function initialize() {
            var chicago = new google.maps.LatLng(55.873686,-4.2518197);
            var mapOptions = {
                zoom: 7,
                center: chicago
            }

            map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);

            infowindow = new google.maps.InfoWindow();
            directionsRenderer.setMap(map);

            google.maps.event.addListener(directionsRenderer, 'routeindex_changed',
                    function() {
                        //alert(directionsRenderer.getRouteIndex());
                    });

        }

        $(window).load(function () {
            initialize();
            var markers = [];
            {% for place in places %}
                markers.push({"id":{{ place.id }},"price":{{ place.price }},"name":"{{ place.name }}","position":{lat: {{ place.lat }} , lng: {{place.lon}}}});
            {% endfor %}
            markers.forEach(function (entry){
                console.log(entry);
                var marker = new google.maps.Marker({
                    position: entry.position,
                    map: map,
                    title: 'Hello World!'
                });
                marker.setMap(map);
                function generateContent(place) {

                    var contentString = '<div id="content">' +
                            '<h3 id="firstHeading" class="firstHeading">'+place.name+'</h3>' +
                            '<div id="bodyContent">' +
                            '<p>TEXT</p>' +
                            '<p>Add to visit list:<button type="button" class="glyphicon glyphicon-plus addplace" id='+place.id+' name="'+place.name+'" />' +
                            '</div>' +
                            '</div>';
                    return contentString;
                }
                var content = generateContent(entry);
                google.maps.event.addListener(marker, 'click', function() {
                    infowindow.setContent(content);
                    infowindow.open(map, this);
                });
            });
        $(document).on('click', '.addplace' ,function(){
            console.log("beep");
            $('#places').append($('<option>', {
                name: this.name,
                value: this.id,
                text: this.name
            }));
        });
        });


    </script>

{% endblock %}
